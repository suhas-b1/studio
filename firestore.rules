/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and impact reports,
 *              public read access with owner-only writes for food listings, and controlled access to claims and verification requests.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 * - /foodListings/{foodListingId}: Stores food listings, publicly readable but writable only by the donor.
 * - /foodListings/{foodListingId}/claims/{claimId}: Stores claims for food listings, with access restricted to the donor and recipient.
 * - /verificationRequests/{verificationRequestId}: Stores verification requests, writable only by the user being verified.
 * - /users/{userId}/impactReports/{impactReportId}: Stores impact reports, accessible only to the user.
 *
 * Key Security Decisions:
 * - Users can only access their own user profile and impact reports.
 * - Food listings are publicly readable, but only the donor can modify them.
 * - Claims can only be created if the user ID matches the recipient ID.
 * - Verification requests can only be created for the requesting user.
 * - User listing is disallowed.
 *
 * Denormalization for Authorization:
 * - FoodListing documents include the `donorId` field to enable owner-based write rules without needing additional `get()` calls.
 * - Claim documents include the `foodListingId` and `recipientId` fields to enable validation of claims without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource and the resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User 'user_abc' can create their profile if request.auth.uid == userId.
     * @allow (get, update, delete) User 'user_abc' can read/update/delete their profile if request.auth.uid == userId.
     * @deny (create) User 'user_def' cannot create a profile for user 'user_abc'.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for food listings.
     * @path /foodListings/{foodListingId}
     * @allow (get, list) Any user can read food listings.
     * @allow (create) User 'user_abc' can create a listing if request.auth.uid == request.resource.data.donorId.
     * @allow (update, delete) User 'user_abc' can update/delete their listing if request.auth.uid == resource.data.donorId.
     * @deny (create) User 'user_def' cannot create a listing for donor 'user_abc'.
     * @principle Public read access with owner-only writes.
     */
    match /foodListings/{foodListingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.donorId == request.auth.uid;
      allow update: if isSignedIn() && resource != null && resource.data.donorId == request.auth.uid;
      allow delete: if isSignedIn() && resource != null && resource.data.donorId == request.auth.uid;
    }

    /**
     * @description Rules for claims on food listings.
     * @path /foodListings/{foodListingId}/claims/{claimId}
     * @allow (create) User 'user_def' can create a claim if request.auth.uid == request.resource.data.recipientId.
     * @allow (get, list) Any user can read claim if is the donor OR recipient.
     * @allow (update, delete) Donor or recipient can update/delete.
     * @deny (create) User 'user_abc' cannot create a claim for recipient 'user_def'.
     * @principle Restricts claim creation to the intended recipient.
     */
    match /foodListings/{foodListingId}/claims/{claimId} {
      allow get: if (isSignedIn() && (resource.data.recipientId == request.auth.uid || get(/databases/$(database)/documents/foodListings/$(foodListingId)).data.donorId == request.auth.uid));
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.recipientId == request.auth.uid;
      allow update: if (isSignedIn() && (resource.data.recipientId == request.auth.uid || get(/databases/$(database)/documents/foodListings/$(foodListingId)).data.donorId == request.auth.uid));
      allow delete: if (isSignedIn() && (resource.data.recipientId == request.auth.uid || get(/databases/$(database)/documents/foodListings/$(foodListingId)).data.donorId == request.auth.uid));
    }

    /**
     * @description Rules for verification requests.
     * @path /verificationRequests/{verificationRequestId}
     * @allow (create) User 'user_abc' can create a verification request for themselves.
     * @allow (get) Any user can get verification request.
     * @deny (create) User 'user_def' cannot create a verification request for user 'user_abc'.
     * @principle Restricts verification request creation to the requesting user.
     */
    match /verificationRequests/{verificationRequestId} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Rules for impact reports.
     * @path /users/{userId}/impactReports/{impactReportId}
     * @allow (create, get, update, delete) User 'user_abc' can manage their impact reports.
     * @deny (create, get, update, delete) User 'user_def' cannot manage impact reports for user 'user_abc'.
     * @principle Enforces document ownership for impact reports.
     */
    match /users/{userId}/impactReports/{impactReportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.donorId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.donorId == userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}